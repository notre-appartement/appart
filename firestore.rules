rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ====================
    // FONCTIONS UTILITAIRES
    // ====================

    // Vérifie si l'utilisateur est authentifié
    function isAuthenticated() {
      return request.auth != null;
    }

    // Vérifie si l'utilisateur est le propriétaire du document
    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    // Récupère le projet associé
    function getProject(projectId) {
      return get(/databases/$(database)/documents/projets/$(projectId));
    }

    // Vérifie si l'utilisateur est membre d'un projet (via membresUids)
    function isProjectMember(projectId) {
      let projet = getProject(projectId);
      return request.auth.uid in projet.data.membresUids;
    }

    // Vérifie si l'utilisateur est admin d'un projet (via adminsUids)
    function isProjectAdmin(projectId) {
      let projet = getProject(projectId);
      return request.auth.uid in projet.data.adminsUids;
    }

    // Récupère le profil de l'utilisateur
    function getUserProfile() {
      return get(/databases/$(database)/documents/profiles/$(request.auth.uid));
    }


    // ====================
    // COLLECTION: profiles
    // ====================
    match /profiles/{userId} {
      // Lecture : Seulement son propre profil
      allow read: if isOwner(userId);

      // Création : Seulement pour soi-même
      allow create: if isOwner(userId);

      // Mise à jour : Seulement son propre profil
      allow update: if isOwner(userId);

      // Suppression : Impossible (RGPD à gérer via Cloud Functions)
      allow delete: if false;
    }


    // ====================
    // COLLECTION: projets
    // ====================
    match /projets/{projetId} {
      // Lecture : Membres du projet OU utilisateur authentifié (pour recherche par inviteCode)
      // Note: Permettre la lecture pour tous les utilisateurs authentifiés permet
      // la recherche par inviteCode, mais les données sensibles restent protégées
      // car seuls les membres peuvent accéder aux sous-collections (appartements, etc.)
      allow read: if isAuthenticated()
                  && (request.auth.uid in resource.data.membresUids
                      || true); // Permettre la lecture pour recherche par inviteCode

      // Création : Tout utilisateur authentifié
      // Validation : le créateur doit être dans membresUids et adminsUids
      allow create: if isAuthenticated()
                    && request.resource.data.createurId == request.auth.uid
                    && request.auth.uid in request.resource.data.membresUids
                    && request.auth.uid in request.resource.data.adminsUids;

      // Mise à jour : Admins du projet OU ajout d'un nouveau membre (rejoindre) OU retrait d'un membre (quitter)
      // Ne pas modifier : createurId, inviteCode, createdAt
      allow update: if isAuthenticated()
                    && (
                      // Cas 1: L'utilisateur est admin du projet
                      (request.auth.uid in resource.data.adminsUids
                       && request.resource.data.createurId == resource.data.createurId
                       && request.resource.data.inviteCode == resource.data.inviteCode
                       && request.resource.data.createdAt == resource.data.createdAt)
                      ||
                      // Cas 2: L'utilisateur rejoint le projet (ajout de lui-même comme membre)
                      // Vérifier que l'utilisateur n'est pas encore membre mais sera ajouté
                      (!(request.auth.uid in resource.data.membresUids)
                       && request.auth.uid in request.resource.data.membresUids
                       && request.resource.data.createurId == resource.data.createurId
                       && request.resource.data.inviteCode == resource.data.inviteCode
                       && request.resource.data.createdAt == resource.data.createdAt)
                      ||
                      // Cas 3: L'utilisateur quitte le projet (retrait de lui-même comme membre)
                      // Vérifier que l'utilisateur est actuellement membre mais ne le sera plus après
                      (request.auth.uid in resource.data.membresUids
                       && !(request.auth.uid in request.resource.data.membresUids)
                       && request.resource.data.createurId == resource.data.createurId
                       && request.resource.data.inviteCode == resource.data.inviteCode
                       && request.resource.data.createdAt == resource.data.createdAt
                       && request.resource.data.membresUids.size() == resource.data.membresUids.size() - 1)
                    );

      // Suppression : Seuls les admins du projet
      allow delete: if isAuthenticated()
                    && request.auth.uid in resource.data.adminsUids;
    }


    // ====================
    // COLLECTION: envies
    // ====================
    match /envies/{envieId} {
      // Lecture : Seuls les membres du projet
      allow read: if isAuthenticated() && isProjectMember(resource.data.projectId);

      // Création : Seuls les membres du projet
      // Validation : createdBy doit être l'utilisateur actuel
      allow create: if isAuthenticated()
                    && isProjectMember(request.resource.data.projectId)
                    && request.resource.data.createdBy == request.auth.uid;

      // Mise à jour : Seul le créateur de l'envie
      // Ne pas modifier : projectId, createdBy, createdAt
      allow update: if isAuthenticated()
                    && isOwner(resource.data.createdBy)
                    && request.resource.data.projectId == resource.data.projectId
                    && request.resource.data.createdBy == resource.data.createdBy
                    && request.resource.data.createdAt == resource.data.createdAt;

      // Suppression : Créateur ou admin du projet
      allow delete: if isAuthenticated()
                    && (isOwner(resource.data.createdBy)
                        || isProjectAdmin(resource.data.projectId));
    }


    // ====================
    // COLLECTION: appartements
    // ====================
    match /appartements/{appartementId} {
      // Lecture : Membres du projet
      allow read: if isAuthenticated()
                  && isProjectMember(resource.data.projectId);

      // Création : Seuls les membres du projet
      // Note: Les limites d'abonnement doivent être vérifiées côté client
      // et idéalement via Cloud Functions
      allow create: if isAuthenticated()
                    && isProjectMember(request.resource.data.projectId)
                    && request.resource.data.createdBy == request.auth.uid;

      // Mise à jour : Seuls les membres du projet
      // Ne pas modifier : projectId, createdBy, createdAt
      // Exception : Anonymisation possible par les admins
      allow update: if isAuthenticated()
                    && isProjectMember(resource.data.projectId)
                    && request.resource.data.projectId == resource.data.projectId
                    && request.resource.data.createdBy == resource.data.createdBy
                    && request.resource.data.createdAt == resource.data.createdAt;

      // Suppression : Créateur ou admin du projet
      allow delete: if isAuthenticated()
                    && (isOwner(resource.data.createdBy)
                        || isProjectAdmin(resource.data.projectId));
    }


    // ====================
    // COLLECTION: emplacements
    // ====================
    match /emplacements/{emplacementId} {
      // Lecture : Seuls les membres du projet
      allow read: if isAuthenticated() && isProjectMember(resource.data.projectId);

      // Création : Seuls les membres du projet
      // Note: Les limites d'abonnement doivent être vérifiées côté client
      allow create: if isAuthenticated()
                    && isProjectMember(request.resource.data.projectId)
                    && request.resource.data.createdBy == request.auth.uid;

      // Mise à jour : Seul le créateur
      // Ne pas modifier : projectId, createdBy, createdAt
      allow update: if isAuthenticated()
                    && isOwner(resource.data.createdBy)
                    && request.resource.data.projectId == resource.data.projectId
                    && request.resource.data.createdBy == resource.data.createdBy
                    && request.resource.data.createdAt == resource.data.createdAt;

      // Suppression : Créateur ou admin du projet
      allow delete: if isAuthenticated()
                    && (isOwner(resource.data.createdBy)
                        || isProjectAdmin(resource.data.projectId));
    }


    // ====================
    // COLLECTION: checklists
    // ====================
    match /checklists/{checklistId} {
      // Récupère l'appartement associé
      function getAppartement() {
        return get(/databases/$(database)/documents/appartements/$(resource.data.appartementId));
      }

      // Lecture : Membres du projet propriétaire de l'appartement
      allow read: if isAuthenticated() && isProjectMember(getAppartement().data.projectId);

      // Création : Membres du projet propriétaire de l'appartement
      allow create: if isAuthenticated()
                    && isProjectMember(getAppartement().data.projectId);

      // Mise à jour : Membres du projet propriétaire de l'appartement
      // Ne pas modifier : appartementId, createdAt
      allow update: if isAuthenticated()
                    && isProjectMember(getAppartement().data.projectId)
                    && request.resource.data.appartementId == resource.data.appartementId
                    && request.resource.data.createdAt == resource.data.createdAt;

      // Suppression : Admin du projet ou créateur de l'appartement
      allow delete: if isAuthenticated()
                    && (isProjectAdmin(getAppartement().data.projectId)
                        || isOwner(getAppartement().data.createdBy));
    }


    // ====================
    // BLOQUER TOUT LE RESTE
    // ====================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
